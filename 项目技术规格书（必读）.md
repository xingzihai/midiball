这份文档是项目《星轨共鸣》的唯一真理来源（Single Source of Truth）。它包含了确定的所有设计决策、技术选型和架构规范。

---

# 项目规格书：星轨共鸣 (Project Star-Pipe)

**版本：** Final_1.0
**项目代号：** Star-Pipe
**类型：** 线性轨道节奏 / 弹球物理 / 堆叠式音乐构建
**目标平台：** PC / Mobile
**开发模式：** 单人开发 + AI辅助 (Cline)

---

## 1. 核心游戏概念 (Core Concept)

### 1.1 概述

玩家控制一颗代表“主旋律”的光球，在一条预先生成的、无限延伸的曲面管道中高速滑行。管道两侧壁分布着代表音符的“发声器”。玩家通过左右移动撞击发声器来演奏音乐。随着游戏进程，玩家将“召唤”出自动运行的辅助球体（代表鼓点、贝斯等伴奏），最终构建出一首完整的交响乐。

### 1.2 核心体验循环

1. **滑行与撞击：** 玩家在管道内自动前进，控制左右位置撞击发声器。
2. **物理反弹：** 撞击发声器产生悦耳的单音和向管道中心的物理反弹；未撞击（Miss）则撞在空墙壁上产生沉闷的噪音并反弹。
3. **构建（召唤）：** 在特定乐段连续成功撞击“特殊发声器”，召唤代表该乐器轨道的“自动球”，该音轨（如鼓组）永久解除静音。
4. **惩罚（剥离）：** 连续失误 5 次，强制销毁一颗已存在的自动球，对应音轨永久静音，音乐变得残缺。
5. **结算：** 根据最终保留的完整乐团规模结算分数与特效。

---

## 2. 详细玩法机制 (Gameplay Mechanics)

### 2.1 地图与视角

* **结构：** 游戏世界是一个向 Z 轴正方向无限延伸的 U 型管道或半圆管。
* **坐标系：**
* **Z轴 (纵深)：** 代表时间。`Z = 歌曲时间 * 滚动速度`。
* **X轴 (横向)：** 代表音高/位置。范围限制在 `[-5.0, 5.0]`。


* **视角：** 第三人称追尾视角 (Third-Person Follow)。摄像机跟随玩家，且稍微带有延迟平滑 (Damping)。
* **视觉欺骗：** 物理逻辑在直线管道中运算，视觉上通过 Shader 实现“弯曲世界”效果，使管道呈现过山车般的动态扭曲。

### 2.2 玩家控制 (Player Controller)

* **移动输入：**
* PC：A/D 键或 左/右 箭头。
* Mobile：屏幕左/右侧点击或虚拟摇杆。


* **物理模式：** 运动学模拟 (Kinematic)，不使用刚体动力学。
* **前进：** 恒定速度 `ForwardSpeed`。
* **横移：** 输入给予横向加速度或直接修改横向速度。


* **边界反弹逻辑：**
* 当 `Position.x <= -5.0` 或 `Position.x >= 5.0` 时：
* 强制反转 X 轴速度：`Velocity.x = -Velocity.x`。
* 不产生无摩擦力，保持动量守恒。



### 2.3 发声器与互动 (Emitters)

* **生成规则：** 游戏开始前预计算。读取 MIDI 文件，将音符映射为管道壁上的静态触发器。
* 低音 -> 靠近左墙 (-5.0)。
* 高音 -> 靠近右墙 (5.0)。


* **判定逻辑：** 基于距离检测 (Distance Check)，非物理碰撞。
* 判定半径：例如 0.5 单位。
* 判定成功：播放主旋律单音(One-shot sample)，玩家获得向管道中心的弹射力，触发高亮特效。
* 判定失败：玩家穿过判定区，撞击管道物理边界（墙壁），判定为 Miss，连击中断。



### 2.4 自动球系统 (Auto-Bots)

* **定义：** 独立于玩家的小球，代表伴奏轨道（Track 2: Drums, Track 3: Bass, Track 4: Chords）。
* **行为逻辑：** "作弊式"自动飞行。
* 它们不进行物理运算。
* 系统读取 MIDI 中对应轨道的音符时间与位置。
* 使用插值算法 (Lerp/Slerp) 让自动球在 `当前时间` 和 `下一个音符时间` 之间平滑飞行，确保 100% 命中率。


* **生成与销毁：**
* 生成：玩家完成 Challenge 阶段（连续击中 5 个特殊颜色音符） -> 实例化自动球 -> 音轨 Unmute。
* 销毁：玩家触发 Penalty 条件（连续 Miss 5 次） -> 销毁已存在的最高级自动球 -> 音轨 Mute。



---

## 3. 技术架构与技术栈 (Technical Architecture)

### 3.1 核心技术栈

* **引擎：** Unity 2022 LTS 或 Unity 6。
* **语言：** C# (.NET Standard 2.1)。
* **关键库：**
* `Melanchall.DryWetMidi` (用于 MIDI 解析)。
* `UniTask` (用于优化的异步操作)。


* **必选插件：** `Curved World` (Asset Store) 或同类顶点偏移 Shader。

### 3.2 目录结构与模块划分 (Modular Monolith)

必须严格遵守以下目录结构，模块间严禁互相引用，仅通过 `_Core` 通信。

1. **_Core/** (公共基础层 - 所有模块可读)
* `EventBus.cs`: 静态事件总线，包含所有游戏事件定义。
* `GameConstants.cs`: 全局常量（如轨道宽度、判定半径）。
* `ServiceLocator.cs`: 简单的服务定位器，用于获取 `IAudioConductor` 等接口。


2. **Audio/** (音频系统 - 独立模块)
* `AudioConductor.cs`: 核心控制器。使用 `AudioSettings.dspTime` 管理时间。
* `StemsManager.cs`: 管理 4-5 个同步播放的 AudioSource（分层音轨）。
* `MidiParser.cs`: 解析 .mid 文件并缓存数据。


3. **Map/** (地图生成系统 - 独立模块)
* `MapGenerator.cs`: 实例化发声器对象池。
* `PipeRenderer.cs`: 管道网格生成或 Shader 控制。


4. **Gameplay/** (游戏逻辑 - 独立模块)
* `PlayerController.cs`: 玩家输入与运动学物理。
* `AutoBotController.cs`: 自动球的插值运动逻辑。
* `GameStateManager.cs`: 判定胜负、分数、召唤/惩罚逻辑。


5. **Visuals/** (视觉表现 - 独立模块)
* `VFXController.cs`: 粒子、光效、拖尾。
* `CameraFollow.cs`: 追尾摄像机逻辑。



### 3.3 关键技术实现细节

**A. 音频同步 (Audio Sync)**

* 严禁使用 `Time.time` 或 `Time.deltaTime` 来驱动游戏进度。
* **唯一时间基准：** `double songTime = AudioSettings.dspTime - dspStartTime;`
* 所有物体沿 Z 轴的位置公式：`float zPosition = (float)songTime * GameConstants.SCROLL_SPEED;`

**B. 模拟物理 (Simulated Physics)**

* 玩家物体不挂载 `Rigidbody`。
* 在 `Update` 循环中：
```csharp
// 伪代码逻辑
Vector3 displacement = new Vector3(velocity.x, 0, forwardSpeed) * Time.deltaTime;
transform.Translate(displacement);
// 边界检查
if (transform.position.x > 5 || transform.position.x < -5) {
    velocity.x = -velocity.x; // 反弹
    ClampPosition();
}

```



**C. 事件总线协议 (Event Protocol)**
模块间通信必须通过 `EventBus`。

* `EventBus.OnNoteHit(NoteType type, Vector3 position)`: 击中音符时触发 -> 视觉播放特效，音频播放单音，Gameplay 增加连击。
* `EventBus.OnTrackUnlocked(TrackType track)`: 召唤成功 -> Audio 模块解除对应音轨静音。
* `EventBus.OnTrackLost(TrackType track)`: 惩罚触发 -> Audio 模块静音对应音轨。

---

## 4. 视觉与美术风格 (Visual & Art Style)

### 4.1 风格定义

* **关键词：** 极简主义、赛博几何、生物机械、星空。
* **参考：** 《Thumper》（速度感与轨道），《Audiosurf》（色彩与块状感）。

### 4.2 视觉元素

* **管道：** 不是实体管道，而是由光栅网格（Grid）组成的半透明隧道。
* **发声器（未激活）：** 黯淡的机械方块或悬浮几何体。
* **发声器（激活/撞击）：** 瞬间爆裂为高亮的光粒子，向四周扩散。
* **背景：**
* 初始：漆黑，只有网格线。
* 进程中：随着音轨解锁，背景出现星云、极光。
* 高潮：全屏色彩脉冲，伴随弯曲世界的剧烈扭曲。



---

## 5. 开发路线图 (Implementation Steps)

请务必按此顺序执行任务，严禁跳跃。

**阶段 1: 核心引擎与数据层**

1. 创建 Unity 工程，配置 .NET 环境。
2. 建立目录结构 (`_Core`, `Audio`, `Gameplay` 等)。
3. 编写 `EventBus` 和 `NoteData` 结构体。
4. 编写 `MidiParser`，验证能成功读取 MIDI 文件并打印音符信息。

**阶段 2: 音频同步与基础移动**

1. 实现 `AudioConductor`，加载 WAV 分轨，确保 `dspTime` 同步播放。
2. 实现 `PlayerController`，实现基于 `dspTime` 的 Z 轴移动和基于输入的 X 轴反弹。
3. 验证：玩家是否随音乐稳定前进，不发生漂移。

**阶段 3: 地图生成与交互**

1. 实现 `MapGenerator`，根据解析的 MIDI 数据在管道两侧生成方块（占位符）。
2. 实现“撞击判定”与“撞墙反弹”逻辑。
3. 验证：撞击方块是否触发声音，撞墙是否反弹。

**阶段 4: 游戏循环与进阶机制**

1. 实现 `AutoBot` 逻辑（自动球）。
2. 实现“召唤”与“惩罚”的状态机逻辑。
3. 集成 `Curved World` 效果。

**阶段 5: 美术与打磨**

1. 替换方块模型为发光粒子特效。
2. 调整物理手感（速度、阻力）。
3. UI 与 结算流程。