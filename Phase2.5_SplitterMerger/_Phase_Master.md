# 阶段2.5：分光镜与汇光镜 - 总规划 ✅ 已完成

## 1. 阶段目标
在阶段2（回溯+动态速度）基础上，实现：
- 碰撞墙之间最小间距≥25px（实际MIN_WALL_DIST=25）
- 墙体放置采用**交替横竖正交优先**策略（偶数墙横放、奇数墙竖放）
- 和弦检测与分组：时间差<50ms的音符归为和弦组
- **分光镜(Splitter)**：和弦组第一个音符标记为SPLITTER，携带chordNotes
- **汇光镜(Merger)**：和弦组后第一个满足间距的单音符标记为MERGER
- 前端播放和弦音符、视觉标记（菱形/圆形边框）

## 2. 实际完成成果

### 2.1 编码器改进
- **chord_grouper.py（新建）**：和弦分组+汇光镜目标预计算
- **path_planner.py（重构）**：
  - 交替横竖正交法线优先（偶数idx→横墙法线0,±1，奇数idx→竖墙法线±1,0）
  - 随机方向重试：尝试不同飞行方向+正交法线组合
  - 智能强制放置：多方向多距离倍数搜索最远离已有墙的位置
  - 碰撞结果：978墙col=0（零碰撞），回溯14670次，耗时12.9s
- **collision_detector.py**：空间网格哈希加速碰撞检测（无变更）
- **mdbl_writer.py**：支持type和chordNotes字段输出
- **main.py**：集成和弦分组，打印SPLITTER/MERGER统计

### 2.2 播放器改进
- **types.ts**：TimelineEvent增加type和chordNotes可选字段
- **audio-engine.ts**：SPLITTER触发时同时播放所有chordNotes
- **renderer.ts**：SPLITTER菱形边框+菱形光晕，MERGER圆形边框+圆形光晕

### 2.3 测试数据（时间煮雨.mid）
| 指标 | 值 |
|------|-----|
| 总音符 | 1866 |
| 和弦分组 | 978组（其中和弦422组） |
| SPLITTER | 422|
| MERGER | 256 |
| 碰撞数 | 0 |
| 回溯次数 | 14670 |
| 生成耗时 | 12.9s |

## 3. 核心算法

### 3.1 交替横竖正交法线
```
偶数idx → 优先法线 [0,±1]（横墙），备选 [±1,0]
奇数idx → 优先法线 [±1,0]（竖墙），备选 [0,±1]
按与飞行方向的点积绝对值排序，优先选择反射效果最好的法线
```

### 3.2 三级放置策略
1. **正交优先**：沿当前方向飞行dist距离，尝试4个正交法线
2. **随机方向重试**（30次）：偏转±60°飞行方向，再尝试正交法线
3. **智能强制放置**：4个距离倍数×7个角度偏移=28种候选，选最远离已有墙的

### 3.3 和弦分组与汇光镜预计算
- group_notes：时间差<50ms归为和弦组
- compute_merger_targets：从和弦组后向后扫描，找第一个间距≥MIN_WALL_DIST的单音符组

## 4. 为第三阶段打下的基础
- SPLITTER/MERGER类型标记和数据结构已就位
- chordNotes数据完整（note/velocity/instrumentId）
- 前端已支持type字段解析和视觉区分
- 第三阶段需实现：编码器端子球独立路径规划 + 播放器端多球并发渲染

## 5. 当前参数
| 参数 | 值 | 说明 |
|------|-----|------|
| MIN_WALL_DIST | 25px | 墙体最小间距 |
| MIN_DISTANCE | 25px | 最小飞行距离 |
| MAX_RETRIES | 30 | 随机方向重试次数 |
| BT_PER_WALL | 15 | 每墙回溯上限系数 |
| CHORD_THRESHOLD_MS | 50ms | 和弦检测阈值 |
| V_MIN/V_MAX | 150/600 px/s | 动态速度范围 |
